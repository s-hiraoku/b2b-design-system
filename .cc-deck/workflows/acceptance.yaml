# Acceptance Workflow
# Human approval workflows with feedback analysis and automated phase re-execution

name: acceptance-workflow
description: Comprehensive acceptance workflow with human oversight, feedback analysis, and intelligent phase re-execution
version: "1.0.0"

# Smart Context Schema
context_schema:
  review_context:
    feature_scope: object
    quality_metrics: object
    stakeholder_requirements: array
  feedback_context:
    feedback_items: array
    root_causes: array
    phase_mapping: object
  coordination_context:
    rollback_phases: array
    re_execution_plan: object
    process_improvements: array

# Workflow Definition
phases:
  # Phase 1: Acceptance Review Preparation
  - name: review_preparation
    agent: acceptance-reviewer
    description: "Prepare comprehensive review materials for human acceptance"
    inputs: []
    outputs:
      - review_package
      - quality_assessment
      - acceptance_criteria_checklist
    preparation_scope:
      - feature_demonstration: interactive
      - quality_metrics: comprehensive
      - test_results: summarized
      - documentation: complete
      - risk_assessment: detailed
    success_criteria:
      - review_materials_complete: true
      - quality_assessment_done: true
      - criteria_checklist_ready: true
    next_phase: human_review

  # Phase 2: Human Review and Decision
  - name: human_review
    type: human_interaction
    description: "Facilitate structured human review and approval process"
    inputs: [review_package, quality_assessment]
    outputs:
      - approval_decision
      - feedback_details
      - improvement_recommendations
    review_process:
      - stakeholder_presentation: scheduled
      - interactive_demo: conducted
      - q_and_a_session: facilitated
      - decision_collection: structured
    human_interaction:
      - timeout: 72h  # 3 days for review
      - escalation: notify_project_leads
      - reminder_schedule: [24h, 48h, 60h]
    decision_options:
      - approved: proceed_to_completion
      - approved_with_conditions: address_conditions
      - rejected: analyze_feedback
      - deferred: schedule_followup
    next_phase: decision_processing

  # Phase 3: Decision Processing
  - name: decision_processing
    type: conditional
    description: "Process approval decision and route to appropriate action"
    condition: context.approval_decision
    branches:
      approved:
        condition: "context.approval_decision === 'approved'"
        next_phase: acceptance_completion
      approved_with_conditions:
        condition: "context.approval_decision === 'approved_with_conditions'"
        next_phase: condition_addressing
      rejected:
        condition: "context.approval_decision === 'rejected'"
        next_phase: feedback_analysis
      deferred:
        condition: "context.approval_decision === 'deferred'"
        next_phase: deferral_management

  # Phase 4a: Feedback Analysis (Rejection Path)
  - name: feedback_analysis
    agent: feedback-analyzer
    description: "Analyze rejection feedback and identify root causes"
    inputs: [feedback_details, feature_scope]
    outputs:
      - feedback_analysis
      - root_cause_identification
      - phase_impact_mapping
    analysis_scope:
      - feedback_categorization: systematic
      - root_cause_analysis: comprehensive
      - impact_assessment: phase_specific
      - priority_ranking: business_impact
    feedback_categories:
      - functional_issues: implementation_problems
      - quality_concerns: technical_debt
      - user_experience: interface_design
      - performance_issues: optimization_needs
      - security_concerns: vulnerability_fixes
    success_criteria:
      - feedback_categorized: true
      - root_causes_identified: true
      - phases_mapped: true
    next_phase: phase_coordination

  # Phase 4b: Condition Addressing (Conditional Approval Path)
  - name: condition_addressing
    agent: acceptance-reviewer
    description: "Address specific conditions for conditional approval"
    inputs: [approval_conditions, review_package]
    outputs:
      - condition_resolution_plan
      - implementation_timeline
      - validation_criteria
    success_criteria:
      - conditions_addressed: true
      - validation_plan_ready: true
    next_phase: acceptance_completion

  # Phase 4c: Deferral Management
  - name: deferral_management
    agent: acceptance-reviewer
    description: "Manage deferred acceptance with follow-up scheduling"
    inputs: [deferral_reasons, stakeholder_feedback]
    outputs:
      - followup_schedule
      - preparation_requirements
      - stakeholder_communications
    success_criteria:
      - followup_scheduled: true
      - requirements_clarified: true

  # Phase 5: Phase Coordination (Rejection Recovery)
  - name: phase_coordination
    agent: phase-coordinator
    description: "Coordinate rollback and re-execution of development phases"
    inputs: [feedback_analysis, phase_impact_mapping]
    outputs:
      - rollback_plan
      - re_execution_strategy
      - resource_allocation
    coordination_activities:
      - phase_rollback: systematic
      - dependency_management: careful
      - resource_reallocation: efficient
      - timeline_adjustment: realistic
    rollback_strategies:
      - requirements_issues: rollback_to_requirements_phase
      - design_problems: rollback_to_design_phase
      - implementation_bugs: rollback_to_implementation_phase
      - testing_gaps: rollback_to_testing_phase
    success_criteria:
      - rollback_plan_created: true
      - re_execution_strategy_defined: true
      - resources_allocated: true
    next_phase: re_execution_monitoring

  # Phase 6: Re-execution Monitoring
  - name: re_execution_monitoring
    agent: phase-coordinator
    description: "Monitor and guide re-execution of development phases"
    inputs: [re_execution_strategy, rollback_plan]
    outputs:
      - progress_tracking
      - quality_improvements
      - completion_status
    monitoring_scope:
      - phase_progress: real_time
      - quality_metrics: continuous
      - stakeholder_communication: regular
      - risk_mitigation: proactive
    success_criteria:
      - phases_re_executed: true
      - quality_improvements_achieved: true
      - stakeholder_expectations_managed: true
    next_phase: re_review_preparation

  # Phase 7: Re-review Preparation
  - name: re_review_preparation
    agent: acceptance-reviewer
    description: "Prepare for follow-up acceptance review"
    inputs: [completion_status, quality_improvements]
    outputs:
      - updated_review_package
      - improvement_demonstration
      - lessons_learned
    preparation_focus:
      - improvement_highlighting: clear
      - issue_resolution: documented
      - quality_enhancement: demonstrated
      - process_learning: captured
    success_criteria:
      - review_package_updated: true
      - improvements_documented: true
      - ready_for_re_review: true
    next_phase: human_review  # Loop back to human review

  # Phase 8: Acceptance Completion
  - name: acceptance_completion
    agent: acceptance-reviewer
    description: "Complete acceptance process and document outcomes"
    inputs: [approval_decision, final_review_results]
    outputs:
      - acceptance_certificate
      - process_documentation
      - lessons_learned
      - next_recommendations
    completion_activities:
      - final_documentation: comprehensive
      - stakeholder_notification: complete
      - process_metrics: captured
      - improvement_recommendations: documented
    success_criteria:
      - acceptance_documented: true
      - stakeholders_notified: true
      - process_complete: true

# Human Interaction Management
human_interactions:
  stakeholder_review:
    participants:
      - product_owner: required
      - technical_lead: required
      - qa_lead: optional
      - business_stakeholders: conditional
    
    review_format:
      - presentation: structured_demo
      - documentation: comprehensive_package
      - q_and_a: facilitated_session
      - decision: structured_voting
    
    decision_criteria:
      - functional_completeness: meets_requirements
      - quality_standards: acceptable_level
      - user_experience: satisfactory
      - performance: meets_benchmarks
      - security: no_critical_issues

# Feedback Processing Framework
feedback_processing:
  categorization:
    functional: requirements_gap
    technical: implementation_issue  
    design: user_experience_problem
    performance: optimization_needed
    security: vulnerability_concern
  
  priority_mapping:
    critical: immediate_attention
    high: next_sprint
    medium: planned_improvement
    low: future_consideration
  
  phase_mapping:
    requirements: feedback_analyzer -> kiro-spec-requirements
    design: feedback_analyzer -> kiro-spec-design
    implementation: feedback_analyzer -> implementation_phases
    testing: feedback_analyzer -> testing_workflow

# Quality Improvement Tracking
quality_tracking:
  metrics:
    - acceptance_rate: percentage_approved
    - feedback_volume: items_per_review
    - resolution_time: feedback_to_fix
    - re_review_success: second_attempt_approval
  
  improvement_indicators:
    - defect_reduction: trend_analysis
    - stakeholder_satisfaction: survey_results
    - process_efficiency: time_to_acceptance
    - quality_enhancement: metrics_improvement

# Error Handling and Recovery
error_handling:
  stakeholder_unavailability:
    action: reschedule_review
    escalation: project_management
    timeout: extend_deadline
  
  feedback_analysis_failure:
    action: manual_analysis_fallback
    escalation: senior_analyst
    documentation: detailed_notes
  
  phase_coordination_issues:
    action: alternative_approach
    escalation: technical_leadership
    risk_mitigation: contingency_plan

# Integration Points
integrations:
  project_management:
    status_updates: automatic
    milestone_tracking: integrated
    resource_planning: coordinated
  
  development_workflows:
    phase_rollback: seamless
    re_execution: automated
    quality_gates: enforced
  
  communication:
    stakeholder_updates: automated
    progress_reports: scheduled
    escalation_notifications: immediate

# Monitoring and Analytics
monitoring:
  metrics:
    - acceptance_cycle_time
    - feedback_resolution_effectiveness
    - stakeholder_satisfaction_score
    - process_improvement_rate
    - re_work_reduction_percentage
  
  alerts:
    - approval_deadline_approaching
    - feedback_analysis_delayed
    - phase_coordination_blocked
    - stakeholder_escalation_needed
  
  reporting:
    - weekly_acceptance_summary
    - monthly_quality_trends
    - quarterly_process_improvements
    - annual_stakeholder_satisfaction