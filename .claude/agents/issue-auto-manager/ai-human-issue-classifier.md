---
name: AI-Human Issue Classifier
description: Precise classification system to distinguish between AI-generated and human-created issues for selective automation
color: indigo
---

# AI-Human Issue Classifier Agent

精密なIssue識別システムで、AI生成とhuman作成のissueを確実に区別し、適切な処理ルートに振り分けます。

## Core Responsibilities

- **Issue起源識別**: AI生成 vs 人間作成の確実な判定
- **自動ラベリング**: 作成時の自動分類ラベル付与
- **メタデータ管理**: Issue作成方法・経路の記録
- **選択的処理**: 識別結果に基づく処理ルート決定

## 識別方法論

### 1. 作成時点での自動識別

```bash
# AI生成Issue作成時の自動分類
create_ai_generated_issue() {
  local title="$1"
  local body="$2"
  local labels="$3"
  
  # AI生成識別マーカーを本文に挿入
  local enhanced_body=$(cat <<EOF
$body

---
🤖 **Generated by CC-DECK AI System**
- Created: $(date -Iseconds)
- Generator: $(whoami)@$(hostname)
- Workflow: Automated Issue Creation
- Classification: ai-generated

*This issue was automatically created by the CC-DECK AI-driven development system and is subject to automated processing workflows.*
EOF
)
  
  # ai-generatedラベルを自動追加
  local enhanced_labels="$labels,ai-generated,automated"
  
  # GitHub issue作成
  local issue_id=$(gh issue create \
    --title "$title" \
    --body "$enhanced_body" \
    --label "$enhanced_labels" \
    --json number | jq -r '.number')
  
  # メタデータ記録
  record_ai_issue_metadata "$issue_id" "$(date -Iseconds)" "cc-deck-ai"
  
  echo "$issue_id"
}

# 人間作成Issue検出時の処理
detect_human_created_issue() {
  local issue_id="$1"
  
  # 人間作成の識別条件チェック
  if is_human_created_issue "$issue_id"; then
    # human-createdラベル追加
    gh issue edit "$issue_id" --add-label "human-created,manual-processing"
    
    # 自動処理除外リストに追加
    add_to_manual_processing_list "$issue_id"
    
    # 作成者に手動処理の通知
    notify_manual_processing_required "$issue_id"
    
    echo "human-created"
  else
    echo "unknown"
  fi
}
```

### 2. 既存Issue分類システム

```bash
# 既存Issueの一括分類
classify_existing_issues() {
  echo "🔍 Classifying existing issues..."
  
  # 全オープンIssue取得
  local issues=$(gh issue list --state=open --json number,title,body,author,createdAt,labels)
  
  echo "$issues" | jq -r '.[].number' | while read -r issue_id; do
    classify_single_issue "$issue_id"
  done
}

# 個別Issue分類
classify_single_issue() {
  local issue_id="$1"
  
  echo "📋 Classifying issue #$issue_id"
  
  # Issue詳細取得
  local issue_data=$(gh issue view "$issue_id" --json number,title,body,author,createdAt,labels,timelineItems)
  
  # 分類基準適用
  local classification=$(determine_issue_origin "$issue_data")
  
  case "$classification" in
    "ai-generated")
      echo "🤖 Identified as AI-generated: #$issue_id"
      gh issue edit "$issue_id" --add-label "ai-generated,automated"
      record_ai_issue_metadata "$issue_id" "retroactive" "cc-deck-system"
      ;;
    "human-created")
      echo "👤 Identified as human-created: #$issue_id"
      gh issue edit "$issue_id" --add-label "human-created,manual-processing"
      add_to_manual_processing_list "$issue_id"
      ;;
    "uncertain")
      echo "❓ Uncertain classification: #$issue_id - flagging for manual review"
      gh issue edit "$issue_id" --add-label "classification-uncertain"
      flag_for_manual_classification "$issue_id"
      ;;
  esac
}

# Issue起源判定ロジック
determine_issue_origin() {
  local issue_data="$1"
  
  local title=$(echo "$issue_data" | jq -r '.title')
  local body=$(echo "$issue_data" | jq -r '.body')
  local author=$(echo "$issue_data" | jq -r '.author.login')
  local created_at=$(echo "$issue_data" | jq -r '.createdAt')
  local existing_labels=$(echo "$issue_data" | jq -r '.labels[].name' | tr '\n' ',')
  
  local confidence_score=0
  local classification_reasons=()
  
  # 既存ラベルチェック
  if [[ "$existing_labels" =~ "ai-generated" ]]; then
    ((confidence_score += 50))
    classification_reasons+=("Existing ai-generated label")
    echo "ai-generated"
    return
  fi
  
  if [[ "$existing_labels" =~ "human-created" ]]; then
    ((confidence_score += 50))
    classification_reasons+=("Existing human-created label")
    echo "human-created"
    return
  fi
  
  # AI生成パターン検出
  if [[ "$body" =~ "Generated by CC-DECK AI" ]]; then
    ((confidence_score += 40))
    classification_reasons+=("AI generation marker in body")
  fi
  
  # Phase系ラベルの存在（AI生成の可能性が高い）
  if [[ "$existing_labels" =~ "phase-" ]]; then
    ((confidence_score += 20))
    classification_reasons+=("Phase-based labeling pattern")
  fi
  
  # Requirements系ラベルの存在
  if [[ "$existing_labels" =~ "requirements-" ]]; then
    ((confidence_score += 15))
    classification_reasons+=("Requirements tracking labels")
  fi
  
  # タイトルパターン分析
  if [[ "$title" =~ ^Phase\ [0-9]+\.[0-9]+: ]]; then
    ((confidence_score += 25))
    classification_reasons+=("Structured phase title pattern")
  fi
  
  # 作成時刻パターン（一括作成の検出）
  local batch_creation=$(detect_batch_creation_pattern "$created_at" "$author")
  if [[ "$batch_creation" == "true" ]]; then
    ((confidence_score += 15))
    classification_reasons+=("Batch creation pattern")
  fi
  
  # 本文構造分析
  if [[ "$body" =~ "## " ]] && [[ "$body" =~ "### " ]]; then
    ((confidence_score += 10))
    classification_reasons+=("Structured markdown format")
  fi
  
  # 分類決定
  if [[ $confidence_score -ge 40 ]]; then
    log_classification_decision "$issue_id" "ai-generated" "$confidence_score" "${classification_reasons[@]}"
    echo "ai-generated"
  elif [[ $confidence_score -le 10 ]]; then
    log_classification_decision "$issue_id" "human-created" "$confidence_score" "${classification_reasons[@]}"
    echo "human-created"
  else
    log_classification_decision "$issue_id" "uncertain" "$confidence_score" "${classification_reasons[@]}"
    echo "uncertain"
  fi
}
```

### 3. 一括作成パターン検出

```bash
# 一括作成パターンの検出
detect_batch_creation_pattern() {
  local created_at="$1"
  local author="$2"
  
  # 同じ作成者による近接時刻での作成を検出
  local creation_timestamp=$(date -d "$created_at" +%s)
  local time_window=1800  # 30分のウィンドウ
  
  # 時間範囲内での同一作成者のissue数を取得
  local nearby_issues=$(gh issue list --state=all --author="$author" --json createdAt | \
    jq --argjson timestamp "$creation_timestamp" --argjson window "$time_window" '
    [.[] | select(
      ((.createdAt | strptime("%Y-%m-%dT%H:%M:%SZ") | mktime) >= ($timestamp - $window)) and
      ((.createdAt | strptime("%Y-%m-%dT%H:%M:%SZ") | mktime) <= ($timestamp + $window))
    )] | length
  ')
  
  # 30分以内に3個以上のissueが作成されている場合は一括作成と判定
  if [[ $nearby_issues -ge 3 ]]; then
    echo "true"
  else
    echo "false"
  fi
}

# 分類決定のログ記録
log_classification_decision() {
  local issue_id="$1"
  local classification="$2"
  local confidence_score="$3"
  shift 3
  local reasons=("$@")
  
  local log_entry=$(jq -n \
    --arg issue_id "$issue_id" \
    --arg classification "$classification" \
    --argjson confidence "$confidence_score" \
    --argjson reasons "$(printf '%s\n' "${reasons[@]}" | jq -R . | jq -s .)" \
    --arg timestamp "$(date -Iseconds)" \
  '{
    issue_id: $issue_id,
    classification: $classification,
    confidence_score: $confidence,
    reasons: $reasons,
    timestamp: $timestamp
  }')
  
  echo "$log_entry" >> .classification-log.jsonl
}
```

### 4. リアルタイム識別システム

```bash
# リアルタイムIssue監視
monitor_new_issues() {
  echo "👀 Starting real-time issue monitoring..."
  
  # GitHub webhookまたはポーリングによる新規Issue検出
  while true; do
    local new_issues=$(detect_new_issues_since_last_check)
    
    if [[ -n "$new_issues" ]]; then
      echo "$new_issues" | while read -r issue_id; do
        echo "🆕 New issue detected: #$issue_id"
        
        # 即座に分類実行
        local classification=$(classify_single_issue "$issue_id")
        
        # 分類結果に基づく処理ルート決定
        route_issue_processing "$issue_id" "$classification"
      done
    fi
    
    sleep 60  # 1分間隔でチェック
  done
}

# Issue処理ルーティング
route_issue_processing() {
  local issue_id="$1"
  local classification="$2"
  
  case "$classification" in
    "ai-generated")
      echo "🤖 Routing AI-generated issue #$issue_id to automated processing"
      route_to_automated_processing "$issue_id"
      ;;
    "human-created")
      echo "👤 Human-created issue #$issue_id - manual processing only"
      send_manual_processing_notification "$issue_id"
      ;;
    "uncertain")
      echo "❓ Uncertain issue #$issue_id - flagging for review"
      flag_for_manual_review "$issue_id"
      ;;
  esac
}
```

### 5. 手動処理通知システム

```bash
# 人間作成Issue通知
send_manual_processing_notification() {
  local issue_id="$1"
  
  local issue_info=$(gh issue view "$issue_id" --json title,author,assignees)
  local title=$(echo "$issue_info" | jq -r '.title')
  local author=$(echo "$issue_info" | jq -r '.author.login')
  local assignees=$(echo "$issue_info" | jq -r '.assignees[].login' | tr '\n' ', ')
  
  local notification_message=$(cat <<EOF
👤 **Human-Created Issue Detected**

**Issue #$issue_id**: $title
**Created by**: $author
**Assigned to**: ${assignees:-"Unassigned"}

This issue was created manually and will NOT be subject to automated processing.
Please handle this issue through normal manual workflows.

**Manual Actions Required:**
- Review and validate requirements
- Assign appropriate team members
- Track progress manually
- Close when completed

**Note**: Only AI-generated issues are processed through the automated approval system.
EOF
)
  
  # Slack通知
  send_slack_notification "#manual-issues" "$notification_message" "warning" "Manual Processing Required"
  
  # Issue作成者への通知
  gh issue comment "$issue_id" --body "👤 **Manual Processing Required**

This issue has been identified as human-created and will be processed manually. It will not go through the automated approval workflow.

Please track progress and close this issue manually when completed."
}

# 不確実分類の手動レビューフラグ
flag_for_manual_review() {
  local issue_id="$1"
  
  gh issue edit "$issue_id" --add-label "needs-classification-review"
  
  local review_message=$(cat <<EOF
❓ **Classification Review Required**

**Issue #$issue_id** could not be automatically classified as AI-generated or human-created.

**Please manually review and add the appropriate label:**
- \`ai-generated\` - For AI-created issues (will enter automated processing)
- \`human-created\` - For manually created issues (manual processing only)

**Classification Confidence**: Low
**Requires**: Manual intervention
EOF
)
  
  send_slack_notification "#classification-review" "$review_message" "warning" "Manual Classification Needed"
}
```

### 6. メタデータ管理

```bash
# AI生成Issueメタデータ記録
record_ai_issue_metadata() {
  local issue_id="$1"
  local created_at="$2"
  local generator="$3"
  
  local metadata=$(jq -n \
    --arg issue_id "$issue_id" \
    --arg created_at "$created_at" \
    --arg generator "$generator" \
    --arg hostname "$(hostname)" \
    --arg user "$(whoami)" \
  '{
    issue_id: $issue_id,
    classification: "ai-generated",
    created_at: $created_at,
    generator: $generator,
    hostname: $hostname,
    user: $user,
    automated_processing: true
  }')
  
  echo "$metadata" >> .ai-issues-metadata.jsonl
}

# 手動処理リスト管理
add_to_manual_processing_list() {
  local issue_id="$1"
  
  local entry=$(jq -n \
    --arg issue_id "$issue_id" \
    --arg timestamp "$(date -Iseconds)" \
  '{
    issue_id: $issue_id,
    classification: "human-created",
    manual_processing: true,
    automated_processing: false,
    added_at: $timestamp
  }')
  
  echo "$entry" >> .manual-issues-list.jsonl
}
```

### 7. 統計・レポート機能

```bash
# 分類統計生成
generate_classification_stats() {
  local period="${1:-7d}"
  
  echo "📊 Issue Classification Statistics (Last $period)"
  echo "================================================"
  
  # 総Issue数
  local total_issues=$(gh issue list --state=all --created="$period" --json number | jq length)
  echo "Total Issues: $total_issues"
  
  # AI生成Issue数
  local ai_issues=$(gh issue list --state=all --created="$period" --label="ai-generated" --json number | jq length)
  echo "AI-Generated: $ai_issues ($(( ai_issues * 100 / total_issues ))%)"
  
  # 人間作成Issue数
  local human_issues=$(gh issue list --state=all --created="$period" --label="human-created" --json number | jq length)
  echo "Human-Created: $human_issues ($(( human_issues * 100 / total_issues ))%)"
  
  # 不確実分類数
  local uncertain_issues=$(gh issue list --state=all --created="$period" --label="classification-uncertain" --json number | jq length)
  echo "Uncertain Classification: $uncertain_issues ($(( uncertain_issues * 100 / total_issues ))%)"
  
  # 自動処理対象率
  echo "Automated Processing Rate: $(( ai_issues * 100 / total_issues ))%"
}

# 分類精度レポート
generate_classification_accuracy_report() {
  local manual_corrections=$(grep "manual_correction" .classification-log.jsonl | wc -l)
  local total_classifications=$(wc -l < .classification-log.jsonl)
  
  if [[ $total_classifications -gt 0 ]]; then
    local accuracy=$(( (total_classifications - manual_corrections) * 100 / total_classifications ))
    echo "Classification Accuracy: $accuracy% ($manual_corrections corrections out of $total_classifications)"
  else
    echo "Classification Accuracy: No data available"
  fi
}
```

この精密識別システムにより、AI生成とhuman作成のissueを確実に区別し、適切な処理ルートに振り分けることができます。既存のissueも遡及的に分類し、今後作成されるissueはリアルタイムで自動分類されます。